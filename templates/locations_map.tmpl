<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8/>
    <title>FIND</title>
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href="/static/img/favicon.ico"/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <!-- Bootstrap and JQuery JS -->
    <script src="/static/js/jquery-2.0.0.min.js"></script>
    <script src='/static/js/bootstrap.js'></script>

    <!-- Bootstrap Core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/static/css/2-col-portfolio.css" rel="stylesheet">


    <link href="/static/css/leaflet.css" rel="stylesheet">
    <link href="/static/css/leaflet.usermarker.css" rel="stylesheet">
    <script src='/static/js/leaflet.js'></script>
    <script src='/static/js/leaflet.usermarker.js'></script>
    <script src='/static/js/Leaflet.Marker.SlideTo.js'></script>

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>
        #live-map {
            height: 500px;
        }

        #users-table-container {
            overflow: scroll;
        }
    </style>
</head>

<body>


<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.internalpositioning.com/">
                <svg version="1.2" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="15px" height="15px" viewBox="0 0 15 15" xml:space="preserve">
            <path fill-rule="evenodd" fill="#A7A7A7" d="M7.2,0c0.4,0,0.7,0,1.1,0c0.1,0,0.1,0,0.2,0.1c1.7,0.3,3,1.3,3.7,2.9
	c0.2,0.4,0.2,0.9,0.4,1.3c0,0.3,0,0.6,0,0.9c-0.9,3.7-2.9,6.8-4.8,10C7.7,15.1,7.6,15,7.6,15c-1.1-2-2.2-4-3.2-6
	C3.7,7.8,3.3,6.5,3,5.2c0-0.3,0-0.7,0-1C3,4.2,3,4.1,3,4c0.3-1.6,1.2-2.8,2.6-3.5C6.1,0.3,6.7,0.2,7.2,0z M11.4,4.8
	c0-2-1.7-3.7-3.7-3.7C5.7,1.1,4,2.8,4,4.8c0,2,1.7,3.7,3.7,3.7C9.8,8.4,11.4,6.8,11.4,4.8z" />
            <path fill-rule="evenodd" fill="#A7A7A7" d="M11,3.8c-0.1,0.1-0.2,0.2-0.4,0.3C8.9,2.5,6.4,2.6,4.8,4.1C4.7,4,4.6,3.8,4.4,3.7
	C6.3,1.8,9.5,2,11,3.8z" />
            <path fill-rule="evenodd" fill="#A7A7A7" d="M5.4,4.8C5.3,4.6,5.2,4.5,5.1,4.4C6.2,3,8.9,2.8,10.4,4.5c-0.1,0.1-0.3,0.2-0.4,0.3
	C8.6,3.5,6.8,3.5,5.4,4.8z" />
            <path fill-rule="evenodd" fill="#A7A7A7" d="M6,5.4C5.9,5.3,5.8,5.2,5.7,5.1c0.9-1.1,3-1.1,4,0.1C9.6,5.2,9.5,5.4,9.4,5.5
	C8.9,5,8.4,4.8,7.7,4.7C7.1,4.7,6.5,5,6,5.4z" />
            <path fill-rule="evenodd" fill="#A7A7A7" d="M8.3,6.6c0,0.4-0.3,0.6-0.6,0.6C7.4,7.3,7.1,7,7.1,6.6C7.1,6.3,7.3,6,7.7,6
	C8,6,8.3,6.2,8.3,6.6z" />
            <path fill-rule="evenodd" fill="#A7A7A7" d="M9,5.8C8.9,5.9,8.8,6,8.7,6.1C7.9,5.5,7.5,5.5,6.7,6C6.6,5.9,6.5,5.8,6.4,5.7
	C7,5,8.3,5,9,5.8z" />
          </svg>
                </i> FIND</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li>
                    <a href="/dashboard/{{ .Group }}"><i class="fa fa-tachometer"></i> Dashboard</a>
                </li>
                <li>
                    <a href="/livemap/{{ .Group }}"><i class="fa fa-map"></i> Track Users</a>
                </li>
                <li>
                    <a href="/locationsmap/{{ .Group }}"><i class="fa fa-map"></i> Show Locations</a>
                </li>
                <li>
                    <a href="https://doc.internalpositioning.com/" target="_blank"><i class="fa fa-question-circle"></i>
                        Help</a>
                </li>
                <li>
                    <a href="/logout"><i class="fa fa-sign-out"></i> Logout</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


<!-- Page Content -->
<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12">
            <h2 class="page-header">Location On Map
                <small>view all locations on map</small>
            </h2>
        </div>
    </div>

    <!--<div class="well">-->
    <div class="row">
        <div class="col-md-9 col-sm-12">
            <div class="panel panel-primary" id="map-panel">
                <div class="panel-heading">
                    Map
                </div>
                <div class="panel-body">
                    <div id="live-map"></div>

                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-12">
            <div class="panel panel-success" id="users-list-panel">
                <div class="panel-heading">
                    Locations
                </div>
                <div class="panel-body" id="users-table-container">
                    <table id="users-table" class="table table-responsive table-hover table-condensed table-bordered">
                        <thead>
                        <tr>
                            <td>X</td>
                            <td>Y</td>
                            <td>accuracy</td>
                            <td>count</td>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--</div>-->


</div>

<script type="application/javascript">
    $('#live-map').css('height', $(window.top).height() - 275);
    $('#users-table').parent().css('height', $(window.top).height() - 245);
    var map = L.map('live-map', {
        crs: L.CRS.Simple,
        minZoom: -100,
//        maxZoom: 4
    });
    var bounds = [[-1200, -1800], [1200, 1800]];
    //    var bounds = [[-400, -300], [400, 300]];
    var image = L.imageOverlay('/static/img/Map.png', bounds).addTo(map);
    map.setView([0, 0], -2);

    var markers = {};
    var pattern = /([\d.-]*)[\s]*,[\s]*([\d.-]*)/;

    /*
        var defaults = {
            '1': [-450, -620],
            '2': [60, 100],
            '3': [-180, 700],
            '4': [0, -950],
            '5': [-700, -1360],
            '6': [170, -1500],
            '7': [-30, 1350],
            '8': [-830, 1350]
        };

            $.each(defaults, function (key, val) {

                defaults[key] = L.userMarker(val, {
                    title: key,
                    smallIcon: true
                }).bindPopup(key).addTo(map).on('popupopen', function (e) {
                    defaults[key]._popup.setContent("<b>" + key + "</b><br>x = " + e.target._accMarker._latlng.lat
                        + "<br>y = " + e.target._accMarker._latlng.lng);
                });
            });
     */

    map.on('click', function (e) {
        console.log(e.latlng.lat + "," + e.latlng.lng);
    });

    $.getJSON("/locations?group={{ .Group }}", function (data) {
        var items = [];

        $.each(data.locations, function (key, val) {
            let match = pattern.exec(key);
            if (match) {
                items.push("<tr><td>" + match[1] + "</td><td>" + match[2] + "</td><td>" + val.accuracy + "</td><td>" + val.count + "</td></tr>");

                markers[key] = L.userMarker([match[1], match[2]], {
//                    pulsing: true,
//                    accuracy: 200,
                    title: key,
                    smallIcon: true
                }).bindPopup("<b>x = " + match[1] + "</b><br><b>y = " + match[2] + "</b>").addTo(map);
            } else {
                items.push("<tr><td colspan='2' class='text-center'>" + key + "</td><td>" + val.accuracy + "</td><td>" + val.count + "</td></tr>");

            }
        });

        $("<tbody/>", {
            "class": "tab-content",
            html: items.join("")
        }).appendTo("#users-table");
    });
</script>
</body>

</html>
