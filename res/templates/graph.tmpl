<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8/>
    <title>PARSIN</title>
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href="/static/img/favicon.ico"/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <!-- Bootstrap and JQuery JS -->
    <script src="/static/js/jquery-2.0.0.min.js"></script>
    <script src='/static/js/bootstrap.js'></script>

    <!-- Bootstrap Core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/static/css/2-col-portfolio.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">


    <link href="/static/css/leaflet.css" rel="stylesheet">
    <link href="/static/css/leaflet.usermarker.css" rel="stylesheet">
    <script src='/static/js/leaflet.js'></script>
    <script src='/static/js/leaflet.usermarker.js'></script>
    <script src='/static/js/Leaflet.Marker.SlideTo.js'></script>


    <script src="/static/js/sweetalert.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/sweetalert.css">

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>

        textarea {
            overflow: auto;
            max-width: 100%;
            min-width: 100%;
        }

        #mac-filter-table-container {
            overflow: scroll;
        }
    </style>
</head>

<body>

{{ template "navbar" . }}

<!-- Page Content -->
<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12">
            <h2 class="page-header">Graph
                <small>Set graphs to be used in localization</small>
            </h2>
        </div>
    </div>

    <!--<div class="well">-->
    <div class="row">
        <div class="col-md-5 col-sm-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    graph List
                </div>
                <div class="panel-body">
                    <div id="controller">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="bs-callout bs-callout-info" style="margin: 0 0 15px;padding-bottom: 5px;">
                                    <h4>vertex input</h4>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <input id="map_point_x" type="text" disabled value="X"
                                                       class="form-control"/>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <input id="map_point_y" type="text" disabled value="Y"
                                                       class="form-control"/>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" class="btn btn-info" id="add_vertex_button"
                                                    title="Add Vertex">Add Vertex
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" class="btn btn-info" id="deleteSelected"
                                                    title="Delete selected">Delete
                                            </button>
                                        </div>


                                    </div>
                                    <div class="row">
                                    {{/*<div class="panel panel-warning" id="map-panel">*/}}
                                    {{/*<div class="panel-heading">*/}}
                                    {{/*Current mac filter List*/}}
                                    {{/*</div>*/}}
                                        <div class="panel-body" id="mac-filter-table-container">
                                            <div rows="10">
                                                <table id="vertices_table"
                                                       class="table table-responsive table-hover table-condensed table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <td>Select</td>
                                                        <td>#</td>
                                                        <td>X</td>
                                                        <td>Y</td>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    {{/*</div>*/}}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <textarea style="height: 70%; margin-bottom: 10px"
                                          placeholder='[&#10;   [0,1,0,0],&#10;   [1,0,1,1],&#10;   [0,1,0,0],&#10;   [0,1,0,0]&#10;]'
                                          class="bootbox-input bootbox-input-textarea form-control" id="graphList"
                                          rows="10"></textarea>
                            </div>

                            <div class="col-md-6 col-sm-12">
                                <button type="submit" class="btn btn-warning btn-block" id="setMacFilter"
                                        title="Click to set.">Set
                                </button>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <button type="submit" class="btn btn-danger btn-block" id="clearMacFilter"
                                        title="Click to clear.">Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7 col-sm-12">
            <div class="panel panel-primary" id="map-panel">
                <div class="panel-heading">
                    Map
                </div>
                <div class="panel-body">
                    <div id="graph_map"></div>
                </div>
            </div>
        </div>
    </div>
    <!--</div>-->
</div>

<script type="application/javascript">
    var vertices = []; // list of vertices entered by map

    $('#graph_map').css('height', $(window.top).height() - 275);
    $('#controller').css('height', $(window.top).height() - 245);
    var map = L.map('graph_map', {
        crs: L.CRS.Simple,
        minZoom: -100,
    });
    var bounds = [[-1 * ('{{.MapHeight}}' / 2), -1 * ('{{.MapWidth}}' / 2)], [('{{.MapHeight}}' / 2), ('{{.MapWidth}}' / 2)]];
    var image = L.imageOverlay('{{.MapPath}}', bounds).addTo(map);
    map.setView([0, 0], -2);

    var markers = L.featureGroup().addTo(map);

    map.on('click', function (e) {
        $('#map_point_x').val(Math.round(e.latlng.lat) + ".0");
        $('#map_point_y').val(Math.round(e.latlng.lng) + ".0");
    });


    $('#add_vertex_button').click(function () {
        var vertex = ("<td><input type='checkbox' name='record'></td><td>" + (vertices.length + 1).toString() + "</td><td>" + $('#map_point_x').val() + "</td><td>" + $('#map_point_y').val() + "</td>");
        vertices.push($('#map_point_x').val() + "," + $('#map_point_y').val());
        console.log(vertices);
        $("<tr/>", {
            "class": "tab-content",
            html: vertex
        }).appendTo("#vertices_table>tbody");

        L.userMarker([$('#map_point_x').val(), $('#map_point_y').val()], {
            smallIcon: true
        }).bindPopup("<b>" + $('#map_point_x').val() + "," + $('#map_point_y').val() + "</b>").addTo(markers);
    });


    // Find and remove selected table rows
    $("#deleteSelected").click(function () {
        $("table tbody").find('input[name="record"]').each(function () {
            if ($(this).is(":checked")) {
                $(this).parents("tr").remove();
            }
        });
        console.log(markers)
        //map.removeLayer(L.userMarker( [$('#map_point_x').val(), $('#map_point_y').val()]));
        //todo: delete marker from map. it needs to get the one from the markers list then remove it from map
    });


    $('#setMacFilter').click(function () {
        swal({
                    title: "Set adjacency matrix",
                    type: "info",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true,
                },
                function () {
                    $.ajax({
                        type: 'POST',
                        url: "/setfiltermacs?group={{ .Group }}",
                        data: JSON.stringify({
                            "group": "{{.Group}}",
                            "graphAdjacencyMatrix": JSON.parse($("#graphList").val())
                        }),
                        success: function (data) {
                            console.log(data);

                            if (data['success']) {
                                swal({
                                    title: "Updated!",
                                    text: data['message'],
                                    timer: 2000,
                                    showConfirmButton: true
                                }, function () {
                                    location.reload();
                                });
                            } else {
                                swal("Something went wrong.", data['message'], "error");
                            }

                        },
                        contentType: "application/json",
                        dataType: 'json'
                    });
                });
    });

    $('#clearMacFilter').click(function () {
        swal({
                    title: "Set mac filter",
                    type: "info",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true,
                },
                function () {
                    $.ajax({
                        type: 'POST',
                        url: "/setfiltermacs?group={{ .Group }}",
                        data: JSON.stringify({
                            "group": "{{.Group}}",
                            "macs": JSON.parse("[]")
                        }),
                        success: function (data) {
                            console.log(data);

                            if (data['success'] && data['message'] == "MacFilter Cleared.") {
                                swal({
                                    title: "Updated!",
                                    text: data['message'],
                                    timer: 2000,
                                    showConfirmButton: true
                                }, function () {
                                    location.reload();
                                });
                            } else {
                                swal("Something went wrong.", data['message'], "error");
                            }
                        },
                        contentType: "application/json",
                        dataType: 'json'
                    });
                });
    });
</script>
</body>

</html>
